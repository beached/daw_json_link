<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.17"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DAW JSON Link: Variant Types</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DAW JSON Link
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.17 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Variant Types </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>Variant or sum types are where the json member can have more than one type(like string, number, class, or array). JSON Link supports several forms of variant types</p><ul>
<li>An undiscriminated variant that is limited to a set of alternatives where there is up to one of each of the basic JSON types(array, object, string, number, bool, null). <br  />
</li>
<li>A discriminated variant where the discriminator is another member of the same class. e.g. <code>json { "type": 1, "value": [] }</code> where <code>"value"</code>'s type is determined by <code>"type"</code></li>
<li>A discriminated variant where the discriminator is a submember of the class type being parsed. e.g <code>json { "obj": { "type": 1 } }</code> where "type" determines how the class itself will be parsed</li>
</ul>
<p>Take the following JSON array:</p>
<div class="fragment"><div class="line">[</div>
<div class="line">  {</div>
<div class="line">    &quot;member0&quot;: 5,</div>
<div class="line">    &quot;member1&quot;: &quot;hello&quot;</div>
<div class="line">  },</div>
<div class="line">  {</div>
<div class="line">    &quot;member0&quot;: &quot;world&quot;,</div>
<div class="line">    &quot;member1&quot;: true</div>
<div class="line">  }</div>
<div class="line">]</div>
</div><!-- fragment --><p>Here we have an array of a class that has two members. A variant of types number and string, member0; and a variant of type string and bool, member1.</p>
<p>Too see a working example using this code, refer to <a href="../tests/src/cookbook_variant1_test.cpp">cookbook_variant1_test.cpp</a></p>
<p>The following C++ can provide a mapping. It, also, highlights that the types bool, integers, floating point, std:: string, and previously mapped types can be default mapped to elements that do not require a name. Such as variant, array, and some key_value's.</p>
<div class="fragment"><div class="line">{c++}</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md113"></a>
Important note:</h1>
<p>The elements in the <code>json_variant_type_list</code> must have matching types in the variant alternatives. (e.g. std::string -&gt; json_string, bool -&gt; json_bool )</p>
<h1><a class="anchor" id="autotoc_md114"></a>
Tagged Variants</h1>
<p>It is common to have a tag discriminator in JSON data. The <code>json_tagged_variant</code> member type allows using another parsed member to return an index in a member list to parse. This allows any number of types to be inside the variant.</p>
<p>Below is a JSON array, containing a variant element where the <code>"type"</code> member determines the type of the <code>"value"</code> member. In many JSON documents, the discriminator will be a string.</p>
<div class="fragment"><div class="line">[</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 0,</div>
<div class="line">    &quot;name&quot;: &quot;string value&quot;,</div>
<div class="line">    &quot;value&quot;: &quot;hello&quot;</div>
<div class="line">  },</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 1,</div>
<div class="line">    &quot;name&quot;: &quot;int value&quot;,</div>
<div class="line">    &quot;value&quot;: 5</div>
<div class="line">  },</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 2,</div>
<div class="line">    &quot;name&quot;: &quot;bool value&quot;,</div>
<div class="line">    &quot;value&quot;: false</div>
<div class="line">  }</div>
<div class="line">]</div>
</div><!-- fragment --><p>A member name and a callable are needed to tell the parser which type will parsed.</p>
<p>Too see a working example using this code, refer to <a href="../tests/src/cookbook_variant2_test.cpp">cookbook_variant2_test.cpp</a></p>
<div class="fragment"><div class="line">{c++}</div>
</div><!-- fragment --><p>In the above example, two members are mapped to construct MyClass, <code>"name"</code> and <code>"value"</code>. The variant uses the JSON <code>"type"</code> member to determine the index of the parser to use for the variant value.</p>
<p>Extending the previous example, it auto detected the <code>std::string</code>, <code>int</code>, and <code>bool</code> types and supplied the parser descriptions for them. Lets do it manually.</p>
<p>Below is a JSON array, containing a variant element where the <code>"type"</code> member determines the type of the <code>"value"</code> member. In many JSON documents, the discriminator will be a string.</p>
<div class="fragment"><div class="line"> [</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 0,</div>
<div class="line">    &quot;name&quot;: &quot;string value&quot;,</div>
<div class="line">    &quot;value&quot;: &quot;hello&quot;</div>
<div class="line">  },</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 1,</div>
<div class="line">    &quot;name&quot;: &quot;int value&quot;,</div>
<div class="line">    &quot;value&quot;: 5</div>
<div class="line">  },</div>
<div class="line">  {</div>
<div class="line">    &quot;type&quot;: 2,</div>
<div class="line">    &quot;name&quot;: &quot;bool value&quot;,</div>
<div class="line">    &quot;value&quot;: false</div>
<div class="line">  }</div>
<div class="line">]</div>
</div><!-- fragment --><p>A member name and a Callable are needed to tell the parser which type will parsed.</p>
<p>Too see a working example using this code, refer to <a href="../tests/src/cookbook_variant3_test.cpp">cookbook_variant3_test.cpp</a></p>
<div class="fragment"><div class="line">{c++}</div>
</div><!-- fragment --><p>As you can see, the json_variant_type_list can use terse type names for some, or the full names.</p>
<h1><a class="anchor" id="autotoc_md115"></a>
Submember as tag for tagged_variant</h1>
<p>There are cases where a classes structure is determined by one of it's submembers. This comes up with file versioning.</p>
<p>In our example we have two versions of a config file. The tag member <code>"version"</code> determines the layout of the other members in the example.</p>
<div class="fragment"><div class="line">{</div>
<div class="line">  &quot;version&quot;: 1,</div>
<div class="line">  &quot;name&quot;: &quot;what is the answer to the ultimate question?&quot;,</div>
<div class="line">  &quot;value&quot;: 42,</div>
<div class="line">  &quot;next question&quot;: &quot;what is earth&quot;</div>
<div class="line">}</div>
</div><!-- fragment --><div class="fragment"><div class="line">{</div>
<div class="line">  &quot;version&quot;: 2,</div>
<div class="line">  &quot;config_options&quot;: [</div>
<div class="line">    {</div>
<div class="line">      &quot;name&quot;: &quot;bob&quot;,</div>
<div class="line">      &quot;value&quot;: 42</div>
<div class="line">    }</div>
<div class="line">  ],</div>
<div class="line">  &quot;option2&quot;: 5</div>
<div class="line">}</div>
</div><!-- fragment --><p>The above example shows two distinct JSON objects that both have a <code>"version"</code> member that is a discriminator for the expected data structure.</p>
<div class="fragment"><div class="line"><span class="keyword">namespace </span>version1 {</div>
<div class="line"><span class="keyword">struct </span>Config {</div>
<div class="line">  <span class="keywordtype">int</span> version;</div>
<div class="line">  std::string <a class="code" href="daw__json__link__types_8h.html#aa1e5e6189406b825e4e001d65f35c210">name</a>;</div>
<div class="line">  <span class="keywordtype">int</span> <a class="code" href="daw__json__event__parser_8h.html#af3874c625cee7edbb7e82023085f86c7">value</a>;</div>
<div class="line">  std::string next_question;</div>
<div class="line">};</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span>version2 {</div>
<div class="line"><span class="keyword">struct </span>Config {</div>
<div class="line">  <span class="keywordtype">int</span> version;</div>
<div class="line">  std::map&lt;std::string, int&gt; config_options;</div>
<div class="line">  <span class="keywordtype">int</span> option2;</div>
<div class="line">};</div>
<div class="line">}</div>
<div class="line"><span class="keyword">using</span> configs_t = std::variant&lt;version1::Config, version2::Config&gt;;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">struct </span>Switcher {</div>
<div class="line">  <span class="comment">// Convert JSON tag member to type index</span></div>
<div class="line">  <span class="keywordtype">size_t</span> operator( )( <span class="keywordtype">int</span> <a class="code" href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a> ) <span class="keyword">const</span> {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>( <a class="code" href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a> - 1 );</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get value for Tag from class value</span></div>
<div class="line">  std::size_t operator( )( configs_t <span class="keyword">const</span> &amp;v ) <span class="keyword">const</span> {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">static_cast&lt;</span>std::size_t<span class="keyword">&gt;</span>( v.index( ) );</div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">namespace </span><a class="code" href="namespacedaw_1_1json.html">daw::json</a> {</div>
<div class="line">  <span class="keyword">template</span>&lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>json_data_contract&lt;version1::Config&gt; {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a> = json_member_list&lt;</div>
<div class="line">      json_number&lt;<span class="stringliteral">&quot;version&quot;</span>, <span class="keywordtype">int</span>&gt;,  </div>
<div class="line">      json_string&lt;<span class="stringliteral">&quot;name&quot;</span>&gt;,</div>
<div class="line">      json_number&lt;<span class="stringliteral">&quot;value&quot;</span>, <span class="keywordtype">int</span>&gt;,</div>
<div class="line">      json_string&lt;<span class="stringliteral">&quot;next question&quot;</span>&gt;</div>
<div class="line">    &gt;;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">static</span> constexpr <span class="keyword">auto</span> to_json_data( version1::Config <span class="keyword">const</span> &amp; v ) {</div>
<div class="line">      <span class="keywordflow">return</span> std::forward_as_tuple( v.version, v.name, v.value, v.next_question );</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">template</span>&lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>json_data_contract&lt;version2::Config&gt; {</div>
<div class="line">    <span class="keyword">using</span> <a class="code" href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a> = json_member_list&lt;</div>
<div class="line">      json_number&lt;<span class="stringliteral">&quot;version&quot;</span>, <span class="keywordtype">int</span>&gt;,  </div>
<div class="line">      json_key_value_array&lt;<span class="stringliteral">&quot;config_options&quot;</span>, </div>
<div class="line">        std::map&lt;std::string, int&gt;,</div>
<div class="line">        json_number&lt;<span class="stringliteral">&quot;value&quot;</span>, <span class="keywordtype">int</span>&gt;, </div>
<div class="line">        json_string&lt;<span class="stringliteral">&quot;name&quot;</span>&gt;</div>
<div class="line">      &gt;,</div>
<div class="line">      json_number&lt;<span class="stringliteral">&quot;option2&quot;</span>, <span class="keywordtype">int</span>&gt;</div>
<div class="line">    &gt;;</div>
<div class="line">    </div>
<div class="line">    <span class="keyword">static</span> constexpr <span class="keyword">auto</span> to_json_data( version2::Config <span class="keyword">const</span> &amp; v ) {</div>
<div class="line">      <span class="keywordflow">return</span> std::forward_as_tuple( v.version, v.config_options, v.option2 );</div>
<div class="line">    }</div>
<div class="line">  };</div>
<div class="line">  </div>
<div class="line">  <span class="keyword">template</span>&lt;&gt;</div>
<div class="line">  <span class="keyword">struct </span>json_data_contract&lt;<a class="code" href="namespacestd.html">std</a>::variant&lt;version1::Config, version2::Config&gt;&gt; {</div>
<div class="line">      <span class="keyword">using</span> <a class="code" href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a> = json_submember_tagged_variant&lt;</div>
<div class="line">        json_number&lt;<span class="stringliteral">&quot;version&quot;</span>, <span class="keywordtype">int</span>&gt;,</div>
<div class="line">        Switcher,   </div>
<div class="line">        version1::Config,</div>
<div class="line">        version2::Config</div>
<div class="line">      &gt;;  </div>
<div class="line">  };</div>
<div class="line">}</div>
</div><!-- fragment --> </div></div><!-- contents -->
</div><!-- PageDoc -->
<div class="ttc" id="anamespacedaw_1_1json_html"><div class="ttname"><a href="namespacedaw_1_1json.html">daw::json</a></div><div class="ttdef"><b>Definition:</b> <a href="daw__from__json_8h_source.html#l00022">daw_from_json.h:22</a></div></div>
<div class="ttc" id="adaw__json__event__parser_8h_html_af3874c625cee7edbb7e82023085f86c7"><div class="ttname"><a href="daw__json__event__parser_8h.html#af3874c625cee7edbb7e82023085f86c7">value</a></div><div class="ttdeci">json_parse_handler_result value</div><div class="ttdef"><b>Definition:</b> <a href="daw__json__event__parser_8h_source.html#l00030">daw_json_event_parser.h:30</a></div></div>
<div class="ttc" id="adaw__json__link__types_8h_html_aa1e5e6189406b825e4e001d65f35c210"><div class="ttname"><a href="daw__json__link__types_8h.html#aa1e5e6189406b825e4e001d65f35c210">name</a></div><div class="ttdeci">static constexpr daw::string_view name</div><div class="ttdef"><b>Definition:</b> <a href="daw__json__link__types_8h_source.html#l00459">daw_json_link_types.h:459</a></div></div>
<div class="ttc" id="adaw__json__event__parser_8h_html_a32f1e0329a2cea27fc6478b5d4de3609"><div class="ttname"><a href="daw__json__event__parser_8h.html#a32f1e0329a2cea27fc6478b5d4de3609">type</a></div><div class="ttdeci">StackParseStateType type</div><div class="ttdef"><b>Definition:</b> <a href="daw__json__event__parser_8h_source.html#l00316">daw_json_event_parser.h:316</a></div></div>
<div class="ttc" id="anamespacestd_html"><div class="ttname"><a href="namespacestd.html">std</a></div><div class="ttdef"><b>Definition:</b> <a href="daw__json__value_8h_source.html#l00087">daw_json_value.h:87</a></div></div>
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.17
</small></address>
</body>
</html>
